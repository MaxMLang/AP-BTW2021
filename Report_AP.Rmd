---
title: 'Bundestagswahl 2021: Analyse des Wahlverhalten in Abhängigkeit von soziodemographischen
  Strukturmerkmalen'
author: "Carla Fuchs, Christian Hobelsberger, Max Melchior Lang, Mattia Mohr"
date: "10/30/2021"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(GGally)
library(reshape2)
library(RColorBrewer)
library(viridis)

#loading cleaned data sets
btw_data <- readRDS("btw_data.RDS")
btw_trimmed_data <- readRDS("btw_trimmed_data.RDS")
btw_kerg2_wk <- readRDS("btw_kerg2_wk.RDS")
länder <- st_read("/Users/max/Downloads/Bundesl%C3%A4ndergrenzen_2018-shp/Bundesländergrenzen_2018.shp")
#loading geo data
wk_path <- "Raw Data/btw21_geometrie_wahlkreise_geo_shp_WGS84/Geometrie_Wahlkreise_20DBT_geo.shp"
wk_shp <- st_read(wk_path)
glimpse(wk_shp)

wk_shp$LAND_NR <- NULL
wk_shp$LAND_NAME <- NULL

# joining
btw_geo_data <- left_join(btw_data, wk_shp, by= c("Wahlkreis.Nr" = "WKR_NR"))
btw_trimmed_geo_data <- left_join(btw_trimmed_data, wk_shp, by= c("Wahlkreis.Nr" = "WKR_NR"))
btw_trimmed_geo_data2 <- left_join(btw_trimmed_geo_data, btw_kerg2_wk, by= "Wahlkreis.Nr")
btw_geo_data$WKR_NAME <- NULL
btw_trimmed_geo_data$WKR_NAME <- NULL
```



# Carla
```{r}

```

# Chris
```{r}

```

# Mattia
```{r}

```

# Max




# Heatmap Korrelationsmatrix Strukturvariablen 

```{r}
struktur_only <- btw_trimmed_data %>% 
  select(76:ncol(btw_trimmed_data))

cor_matrix <- cor(struktur_only, use= "pairwise.complete.obs")

cor_matrix_melted <- melt(cor_matrix)

# dev.off()
limit <- max(abs(cor_matrix_melted$value)) * c(-1, 1)


ggplot(data = cor_matrix_melted, aes(x=Var1, y=Var2, fill=value)) + 
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))+
  ggtitle("Korrelationsmatrix der Strukturvariablen")

ggsave("Korr_Matrix_Strukturvariablen.png", path = "Grafiken/", width = 7, height= 7)
```


# SPD Gewinn/Verlust Map

```{r}
spd_zweit <- btw_kerg2_wk %>% 
  filter(Gruppenname == "SPD") %>% 
  filter(Stimme == 2) 

spd_erst <- btw_kerg2_wk %>% 
  filter(Gruppenname == "SPD") %>% 
  filter(Stimme == 1) 

cor(spd_erst$DiffProzentPkt, spd_zweit$DiffProzentPkt)

p1 <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= spd_zweit[["DiffProzentPkt"]]),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-15,16))

ggsave("SPD_Zweit_GV_Map.png", path="Grafiken/", width = 7, height= 7)
```


# CDU Gewinn / Verlust Map
```{r}
union_zweit <- btw_kerg2_wk %>% 
  filter(Gruppenname %in% c("CDU", "CSU")) %>% 
  filter(Stimme == 2)

union_erst <- btw_kerg2_wk %>% 
  filter(Gruppenname %in% c("CDU", "CSU")) %>% 
  filter(Stimme == 1)

cor(union_erst$DiffProzentPkt, union_zweit$DiffProzentPkt)

p1 <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= union_zweit$DiffProzentPkt),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-18,5))

ggsave("Union_Zweit_GV_Map.png", path="Grafiken/", width = 7, height= 7)

```

```{r}
spd_zweit %>% 
  mutate(is.Osten= ifelse(UegGebietsnummer %in% c(10:16), TRUE, FALSE)) %>% 
  ggplot(aes(x= is.Osten, y= DiffProzentPkt))+
  geom_boxplot()

ggsave("SPD_Zweit_O-W_Box.png", path="Grafiken/", width = 7, height= 7)
```

```{r}
union_zweit %>% 
  mutate(is.Osten= ifelse(UegGebietsnummer %in% c(10:16), TRUE, FALSE)) %>% 
  ggplot(aes(x= is.Osten, y= DiffProzentPkt))+
  geom_boxplot()
ggsave("Union_Zweit_O-W_Box.png", path="Grafiken/", width = 7, height= 7)
```


# Kormatrix SPD
```{r}
SPD_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,SPD.Erst.End.Perc,SPD.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) 

cor_matrix_SPD <- cor(SPD_struktur, use= "pairwise") 
cor_matrix_SPD_melted <- melt(cor_matrix_SPD) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_SPD_melted %>% 
  filter(Var1 %in% c("SPD.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

ggsave("Kor_Matrix_SPD_Struktur.png", path = "Grafiken/", width = 7, height= 7)
```

# Kormatrix Union
```{r}
UNION_struktur <- btw_trimmed_geo_data %>% 
  replace(is.na(.), 0) %>% 
  mutate(UNION.Erst.End.Perc= CDU.Erst.End.Perc + CSU.Erst.End.Perc, 
         UNION.Zweit.End.Perc= CDU.Zweit.End.Perc + CSU.Zweit.End.Perc) %>% 
  select(Bundesland.Nr ,UNION.Erst.End.Perc,UNION.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) 
  
cor_matrix_UNION <- cor(UNION_struktur, use= "complete") 
cor_matrix_UNION_melted <- melt(cor_matrix_UNION) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_UNION_melted %>% 
  filter(Var1 %in% c("UNION.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

ggsave("Kor_Matrix_UNION_Struktur.png", path = "Grafiken/", width = 7, height= 7)
```

# Freie Wähler Landtagsbeteiligung + BTW 
```{r}
FW_DiffProzent <- btw_trimmed_geo_data2 %>% 
  filter(Gruppenname %in% "FREIE WÄHLER") %>% 
  filter(Stimme == 2) %>% 
  select(Wahlkreis.Nr, DiffProzent, DiffProzentPkt)

FW_Zweit_data <- btw_trimmed_geo_data %>% 
  select(-c(22:63)) %>% 
  select(-c(28:33))

FW_Diff_Data <- left_join(FW_Zweit_data, FW_DiffProzent, by= "Wahlkreis.Nr")

# Added Logic column if or if not FW in state parliament (RP= 7, BY=9)
FW_Diff_Data <- FW_Diff_Data %>% 
  mutate(is.LT= ifelse(.$Bundesland.Nr%in% c(7,9), TRUE, FALSE))

FW_Diff_Data %>% 
ggplot(aes(x= is.LT, y= DiffProzentPkt))+
  geom_boxplot()
ggsave("LT_FW_DiffPkt_Box.png", path = "Grafiken/", width = 7, height= 7)

FW_Diff_Data %>% 
ggplot(aes(x= is.LT, y= FW.Zweit.End.Perc))+
  geom_boxplot()
ggsave("LT_FW_ZweitPerc_Box.png", path = "Grafiken/", width = 7, height= 7)
```

# Bundesmap FW Stimmen

```{r}
p1 <- FW_Diff_Data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= FW.Zweit.End.Perc))+
  scale_fill_continuous(low= "white", high= "orange")+
  geom_sf(data = länder, color = "black", fill = NA)

ggsave("FW_ZweitPerc_Map.png", path = "Grafiken/", width = 7, height= 7)
```



```{r}
cor_matrix_FW <- cor(select(FW_Diff_Data,-c(1:21,26,76,79)))

cor_matrix_FW_melted <- melt(cor_matrix_FW)

# dev.off()
cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=reorder(Var2,-value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

cor_matrix_FW_melted_sliced <- cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Zweit.End.Perc")) %>% 
  arrange(desc(value)) %>% 
  slice(which(Var2 %in% c("Unternehmen.HW", "Schulab.mitMittSA", "SozPfli.LandW",
                    "Boden.SieduVerk", "Schulab.mitAllgHS", "SozPfli.ÖffPrivDienstl")))

cor_matrix_FW_melted_sliced %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=reorder(Var2,-value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))
ggsave("Kor_Matrix_FW_Struktur_Sliced.png", path = "Grafiken/", width = 7, height= 7)

FW_Diff_Data %>% 
  ggplot(aes(x= Unternehmen.HW, y= FW.Zweit.End.Perc))+
  geom_point(shape= ifelse(FW_Diff_Data$Bundesland.Nr %in% 9, 17, 16), alpha= 0.5)+
  facet_wrap(~is.LT)
  
ggsave("LT_FW_ZweitPerc_Scatter.png", path = "Grafiken/", width = 7, height= 7)
```



# AFD Erst und Zweitstimmen in % Bundesgebiet
```{r}
# Needs to be manually downloaded --> will be in repo after talk with A. Klima
# Link: https://hub.arcgis.com/datasets/esri-de-content::bundesländergrenzen-2018/explore?location=50.999100%2C10.454033%2C6.51
länder <- st_read("/Users/max/Downloads/Bundesl%C3%A4ndergrenzen_2018-shp/Bundesländergrenzen_2018.shp")
cor(btw_trimmed_geo_data$AFD.Erst.End.Perc, btw_trimmed_geo_data$AFD.Zweit.End.Perc, use= "complete")

p1 <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= cut(AFD.Zweit.End.Perc, seq(0,0.35,0.05))),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_brewer(palette = "Blues")

ggsave("AFD_Zweitstimmen.png", path = "/Users/max/Desktop/")


```

# Linke Erst und Zweitstimmen in % Bundesgebiet
```{r}
cor(btw_trimmed_geo_data$LINKE.Erst.End.Perc, btw_trimmed_geo_data$LINKE.Zweit.End.Perc, use= "complete")

p1 <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= cut(LINKE.Zweit.End.Perc,
                                            seq(0,0.35,0.05))),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_brewer(palette = "Reds")

ggsave("LINKE_Zweitstimmen.png", path = "/Users/max/Desktop/")

```

# Hang zu extremen Randparteien (LINKE und AFD) speziell im Osten?

```{r}
p1 <- btw_trimmed_geo_data %>% 
  mutate(Rand.Zweit.End.Perc= LINKE.Zweit.End.Perc + AFD.Zweit.End.Perc) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= Rand.Zweit.End.Perc),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_viridis("magma", trans= "reverse")

ggsave("Randparteien_Bund_Map.png", path = "Grafiken/", width= 7, height= 7)
```



# Korrelationenen Struktur in den neuen Bundesländern AFD

```{r}
AFD_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,AFD.Erst.End.Perc,AFD.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) %>%
  filter(Bundesland.Nr %in% 10:16)

cor_matrix_AFD <- cor(AFD_struktur, use= "complete", method = "spearman") 
cor_matrix_AFD_melted <- melt(cor_matrix_AFD) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_AFD_melted %>% 
  filter(Var1 %in% c("AFD.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))
```

# Korrelationenen Struktur in den neuen Bundesländern LINKE

```{r}
LINKE_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,LINKE.Erst.End.Perc, LINKE.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) %>%
  filter(Bundesland.Nr %in% 10:16)

cor_matrix_LINKE <- cor(LINKE_struktur, use= "complete", method = "spearman") 
cor_matrix_LINKE_melted <- melt(cor_matrix_LINKE) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_LINKE_melted %>% 
  filter(Var1 %in% c("LINKE.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust= 1))
```

# Zusammenhang zwischen älterer Bevölkerung und AFD Stimmen
## Ältere Bevölkerung ü75
```{r}
p1 <- btw_trimmed_geo_data %>% 
ggplot() +     
  geom_sf(aes(geometry= geometry, fill= cut(f75tInf.Perctange, seq(5, 20, 2.5))))+
  scale_fill_brewer(palette = "YlOrRd", drop= FALSE)

ggsave("ätere_Bevölkerung.png", path = "/Users/max/Desktop/")


```

```{r}
btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f75tInf.Perctange, col= is.Osten))+
  geom_point(alpha= 0.5)

btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f75tInf.Perctange, col= is.Berlin))+
  facet_wrap(~is.Osten)+
  geom_point(alpha= 0.5)

btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
  mutate(f60tInf.Perctange= f60t74.Perctange+f75tInf.Perctange) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f60tInf.Perctange, col= is.Berlin))+
  facet_wrap(~is.Osten)+
  geom_point(alpha= 0.5)
  
ggsave("AFD_ue60_O-W_Sctter.png", path = "Grafiken/", width= 7, height= 7)
```

# Ältere Bevölkerung Randparteien
```{r}
btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
  mutate(Rand.Zweit.End.Perc= LINKE.Zweit.End.Perc + AFD.Zweit.End.Perc) %>% 
  mutate(f60tInf.Perctange= f60t74.Perctange+f75tInf.Perctange) %>% 
ggplot(aes(y= Rand.Zweit.End.Perc, x= f60tInf.Perctange, col= is.Berlin))+
  facet_wrap(~is.Osten)+
  geom_point(alpha= 0.25)

ggsave("Rand_ue60_O-W_Sctter.png", path = "Grafiken/", width= 7, height= 7)
```


# Versuche, Überlegungen etc.
# CSU Bayern Map (Erst und Zweitstimmen %)
```{r}
bayern_trimmed <- btw_trimmed_geo_data %>% 
  filter(Bundesland.Nr == 9)

p1 <- bayern_trimmed %>%
  mutate(CSU.Erst.End.Perc.Cut= cut(bayern_trimmed$CSU.Erst.End.Perc,
                                    seq(0.05,0.5,0.05))) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= CSU.Erst.End.Perc.Cut), colour= "white")+
  scale_fill_brewer(palette= "Greys", drop=FALSE)

ggsave("p1.png", path = "/Users/max/Desktop/")



p1 <- bayern_trimmed %>%
  mutate(CSU.Zweit.End.Perc.Cut= cut(bayern_trimmed$CSU.Zweit.End.Perc,
                                    seq(0.05,0.4,0.05))) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= CSU.Zweit.End.Perc.Cut), colour= "white")+
  scale_fill_brewer(palette= "Greys", drop= FALSE)

ggsave("p2.png", path = "/Users/max/Desktop/")
```

# Freie Wähler Bayern Map (Erst und Zweitstimmen %)
```{r}
p1 <- bayern_trimmed %>%
  mutate(FW.Erst.End.Perc.Cut= cut(bayern_trimmed$FW.Erst.End.Perc,
                                    seq(0,0.4,0.05))) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= FW.Erst.End.Perc.Cut))+
  scale_fill_brewer(palette= "Oranges", drop=FALSE)

ggsave("p3.png", path = "/Users/max/Desktop/")

p1 <- bayern_trimmed %>%
  mutate(FW.Zweit.End.Perc.Cut= cut(bayern_trimmed$FW.Zweit.End.Perc,
                                    seq(0,0.4,0.05))) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= FW.Zweit.End.Perc))+
  scale_fill_continuous(low= "white", high= "orange")

ggsave("p4.png", path = "/Users/max/Desktop/")

```

# Soziale Strukturen Bayern Visualisierung
## Landwirtschaft dominante Gebiete
```{r}
p1 <- bayern_trimmed %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= cut(SozPfli.LandW, seq(0,2,0.2))))+
  scale_fill_brewer(palette = "YlOrRd")

ggsave("p5.png", path = "/Users/max/Desktop/")
```

## Gebiete mit hohen Anteil mit niedrigem Schulabschluss
```{r}
p1 <- bayern_trimmed %>% 
  mutate(Niedriger.SA = Schulab.ohneHS + Schulab.mitHS) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= cut(Niedriger.SA, seq(0,35,5))))+
  scale_fill_brewer(palette = "YlOrRd")
ggsave("p6.png", path = "/Users/max/Desktop/")

FW_Struktur <- bayern_trimmed %>%  
  select(FW.Erst.End.Perc,FW.Zweit.End.Perc, 76:ncol(bayern_trimmed), -geometry)
```

# Korrelation Freie Wähler mit obigen sozialen Strukturen
```{r}

cor_matrix_FW <- cor(FW_Struktur, use= "everything", method = "spearman")

cor_matrix_FW_melted <- melt(cor_matrix_FW)

# dev.off()
cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=Var2, fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Zweit.End.Perc")) %>% 
  arrange(desc(value)) %>% 
  slice(which(Var2 %in% c("Unternehmen.HW", "Schulab.mitMittSA", "SozPfli.LandW",
                    "Boden.SieduVerk", "Schulab.mitAllgHS", "SozPfli.ÖffPrivDienstl")))
```

# Korrlationsscatterplots Strukturvariablen

```{r}
struktur_only <- btw_trimmed_data %>% 
  select(76:ncol(btw_trimmed_data))

colSums(is.na(struktur_only))

ggpairs(struktur_only[1:10],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[11:20],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[21:30],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[31:40],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[41:48],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
```

