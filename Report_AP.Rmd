---
title: 'Bundestagswahl 2021: Analyse des Wahlverhalten in Abhängigkeit von soziodemographischen
  Strukturmerkmalen'
author: "Carla Fuchs, Christian Hobelsberger, Max Melchior Lang, Mattia Mohr"
date: "10/30/2021"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(GGally)
library(reshape2)
library(RColorBrewer)
library(viridis)
library(ggpubr)

#loading cleaned data sets
btw_data <- readRDS("btw_data.RDS")
btw_trimmed_data <- readRDS("btw_trimmed_data.RDS")
btw_kerg_trimmed_bundeslaender <- readRDS("btw_kerg_trimmed_bundeslaender.RDS")
btw_kerg2_wk <- readRDS("btw_kerg2_wk.RDS")
länder <- st_read("Raw Data/laender_geometrie_WGS84/Bundesländergrenzen_2018.shp")
btw_kerg2_bund <- readRDS("btw_kerg2_bund.RDS")
#loading geo data
wk_path <- "Raw Data/btw21_geometrie_wahlkreise_geo_shp_WGS84/Geometrie_Wahlkreise_20DBT_geo.shp"
wk_shp <- st_read(wk_path)
glimpse(wk_shp)

wk_shp$LAND_NR <- NULL
wk_shp$LAND_NAME <- NULL

# joining
btw_geo_data <- left_join(btw_data, wk_shp, by= c("Wahlkreis.Nr" = "WKR_NR"))
btw_trimmed_geo_data <- left_join(btw_trimmed_data, wk_shp, by= c("Wahlkreis.Nr" = "WKR_NR"))
btw_trimmed_geo_data2 <- left_join(btw_trimmed_geo_data, btw_kerg2_wk, by= "Wahlkreis.Nr")
btw_geo_data$WKR_NAME <- NULL
btw_trimmed_geo_data$WKR_NAME <- NULL

# editing data

# Adding Union-Cols
btw_kerg_trimmed_bundeslaender[is.na(btw_kerg_trimmed_bundeslaender)] <- 0
btw_kerg_trimmed_bundeslaender <- btw_kerg_trimmed_bundeslaender %>%
  mutate(Union.Erst.Vor = CDU.Erst.Vor + CSU.Erst.Vor,
         Union.Erst.End = CDU.Erst.End + CSU.Erst.End,
         Union.Erst.End.Perc = CDU.Erst.End.Perc + CSU.Erst.End.Perc,
         Union.Zweit.Vor = CDU.Zweit.Vor + CSU.Zweit.Vor,
         Union.Zweit.End = CDU.Zweit.End + CSU.Zweit.End,
         Union.Zweit.End.Perc = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc)

# Partei Farben
partei_colors <- c("black", "red", "blue", "yellow", "purple", "green", "darkgrey")

theme_set(theme_light())

theme_map <- function(...) {
  theme_minimal() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
```



# Carla
```{r}

```

# Chris
```{r}

# Data Structuring: Making a clean Data Frame

ergebnisse_diff_table <- btw_kerg2_bund %>%
  filter(Stimme == 2) %>%
  filter(Gruppenname %in% c("CDU", "CSU", "SPD", "AfD", "FDP", "DIE LINKE", "GRÜNE"))

ergebnisse_diff_table[["DiffProzentPkt"]] <- as.numeric(ergebnisse_diff_table[["DiffProzentPkt"]])

anzahl_stimmen_erst <- sum(btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Erst.End"]])

anzahl_stimmen_zweit <- sum(btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Zweit.End"]])

anzahl_stimmen_gesamt <- sum(btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Erst.End"]] + btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Zweit.End"]])


partei <- c("CDU/CSU", "SPD", "AFD", "FDP", "Linke", "Grüne", "Sonstiges")
stimmen_gesamt <- c(
  sum(btw_kerg_trimmed_bundeslaender[["Union.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["Union.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Zweit.End"]]),
  0
  )

stimmen_erst <- c(
  sum(btw_kerg_trimmed_bundeslaender[["Union.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Erst.End"]]),
  0
  )
stimmen_zweit <- c(
  sum(btw_kerg_trimmed_bundeslaender[["Union.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Zweit.End"]]),
  0
  )

stimmen_zweit_diff_perc <- c(
  sum(ergebnisse_diff_table[1,17], ergebnisse_diff_table[7,17]),
  ergebnisse_diff_table[2:6, 17],
  0
)


ergebnisse_table <- data.frame(partei, stimmen_erst, stimmen_zweit, stimmen_gesamt)

ergebnisse_table[7,2] <- anzahl_stimmen_erst - sum(ergebnisse_table[1:6,2])

ergebnisse_table[7,3] <- anzahl_stimmen_zweit - sum(ergebnisse_table[1:6,3])

ergebnisse_table[7,4] <- anzahl_stimmen_gesamt - sum(ergebnisse_table[1:6,4])

ergebnisse_table <- ergebnisse_table %>%
  mutate(stimmen_erst_perc = stimmen_erst / anzahl_stimmen_erst,
         stimmen_zweit_perc = stimmen_zweit / anzahl_stimmen_zweit,
         stimmen_gesamt_perc = stimmen_gesamt/ anzahl_stimmen_gesamt)

ergebnisse_table[["partei"]] <- factor(ergebnisse_table[["partei"]], levels = ergebnisse_table[["partei"]])

ergebnisse_table <- cbind(ergebnisse_table, stimmen_zweit_diff_perc)

ergebnisse_table


```

# Ergebnisse Bundestagswahl 2021
```{r}
ergebnisse_table %>%
  ggplot(mapping = aes(x = partei, y = stimmen_erst_perc)) +
  geom_bar(stat = "identity", fill = partei_colors) +
  xlab("Partei") +
  ylab("Stimmen (in %)") +
  ggtitle(label = "Ergebnis: Erststimmen Bundestagswahl 2021") +
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::pretty_breaks(n = 10))
  
  ggsave("Ergebnis_Erststimmen.png", path="Grafiken/", width = 7, height= 7)
  
ergebnisse_table %>%
  ggplot(mapping = aes(x = partei, y = stimmen_zweit_perc)) +
  geom_bar(stat = "identity", fill = partei_colors) +
  xlab("Partei") +
  ylab("Stimmen (in %)") +
  ggtitle(label = "Ergebnis: Zweitstimmen Bundestagswahl 2021") +
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::pretty_breaks(n = 10))
  
ggsave("Ergebnis_Zweitstimmen.png", path="Grafiken/", width = 7, height= 7)

ergebnisse_table %>%
  ggplot(mapping = aes(x = partei, y = stimmen_zweit_diff_perc)) +
  geom_bar(stat = "identity", fill = partei_colors) +
  xlab("Partei") +
  ylab("Stimmen (in %)") +
  ggtitle(label = "Ergebnis: Differenzen Zweitstimmen Bundestagswahl 2021") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))

ggsave("Differenzen_Zweitstimmen.png", path="Grafiken/", width = 7, height= 7)
```


# Mattia
```{r}

```

# Max

# SPD und Union (Gewinn Verluste) --> Vor: Soziodemografisch Union SPD
## Boxplot DiffProzentPkt
- Union keine Gewinne!
- SPD so gut wie keine Verluste 
```{r}
spd_zweit <- btw_kerg2_wk %>% 
  filter(Gruppenname == "SPD") %>% 
  filter(Stimme == 2) 

spd_erst <- btw_kerg2_wk %>% 
  filter(Gruppenname == "SPD") %>% 
  filter(Stimme == 1) 

cor(spd_erst$DiffProzentPkt, spd_zweit$DiffProzentPkt)

union_zweit <- btw_kerg2_wk %>% 
  filter(Gruppenname %in% c("CDU", "CSU")) %>% 
  filter(Stimme == 2)

union_erst <- btw_kerg2_wk %>% 
  filter(Gruppenname %in% c("CDU", "CSU")) %>% 
  filter(Stimme == 1)

cor(union_erst$DiffProzentPkt, union_zweit$DiffProzentPkt)

SPD_CDU_CSU_Diff <- rbind(union_zweit, spd_zweit) %>% 
  select(Gruppenname, DiffProzentPkt)

SPD_CDU_CSU_Diff%>% 
  ggplot(aes(x= Gruppenname, y= DiffProzentPkt))+
  geom_boxplot()


SPD_CDU_CSU_Diff[["Gruppenname"]][which(SPD_CDU_CSU_Diff[["Gruppenname"]]%in% c("CDU","CSU"))] <- "Union"

SPD_CDU_CSU_Diff %>% 
  ggplot(aes(x= Gruppenname, y= DiffProzentPkt))+
  geom_boxplot()+
  geom_hline(yintercept = 0, linetype= "dashed", colour= "black")+
  ggtitle("Vergleich der Gewinne/Verluste an Prozentpunkten der Zweitstimmen von SPD und Union (bzgl. der Bundestagswahl 2017")+
  xlab("Partei")+
  ylab("Differenz Prozentpunkte (Zweitstimmen)")
```

## SPD Gewinn/Verlust Map und Union Verlust Map

```{r}

spd_GV <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= spd_zweit[["DiffProzentPkt"]]),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_distiller(name= "Differenz der Prozentpunkte",palette= "RdBu", type = "div", limit= c(-20,20))+
  ggtitle("Gewinne / Verluste an Prozentpunkten von Zweitstimmen der SPD")+
  xlab("")+
  ylab("")+
  theme_map()

ggsave("SPD_Zweit_GV_Map.png", path="Grafiken/", width = 7, height= 7)

union_GV <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= union_zweit$DiffProzentPkt),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_distiller(name= "Differenz der Prozentpunkte",palette= "RdBu", type = "div", limit= c(-20,20))+
  ggtitle("Gewinne / Verluste an Prozentpunkten von Zweitstimmen der Union")+
  xlab("")+
  ylab("")+
  theme_map()

ggsave("Union_Zweit_GV_Map.png", path="Grafiken/", width = 7, height= 7)
```

### In welche Wahlkreisen hatte die SPD die stärksten Zuwächse?
```{r}
spd_zweit %>% 
  arrange(desc(DiffProzentPkt)) %>% 
  slice(1:5) %>% 
  select(Wahlkreis.Nr,Gebietsname, DiffProzentPkt)
```

### Welche Wahlkreise hatte die SPD einen Stimmverlust?
```{r}
spd_zweit %>% 
  slice(which(DiffProzentPkt<0)) %>% 
  select(Gebietsname)
```


### In welchen Wahlkreisen hatte die Union die stärksten Verluste?

```{r}
union_zweit %>% 
  arrange(DiffProzentPkt) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```

```{r}
union_erst %>% 
  arrange(DiffProzentPkt) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```

### In welchen Wahlkreisen hatte die Union die geringsten Verluste?
```{r}
union_zweit %>% 
  arrange(desc(DiffProzentPkt)) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```


# Freie Wähler Landtagsbeteiligung + BTW
```{r}
cor(btw_trimmed_data$FW.Erst.End.Perc, btw_trimmed_data$FW.Zweit.End.Perc, use= "complete")

FW_DiffProzent <- btw_trimmed_geo_data2 %>% 
  filter(Gruppenname %in% "FREIE WÄHLER") %>% 
  filter(Stimme == 2) %>% 
  select(Wahlkreis.Nr, DiffProzent, DiffProzentPkt)

FW_Zweit_data <- btw_trimmed_geo_data %>% 
  select(-c(22:63)) %>% 
  select(-c(28:33))

FW_Diff_Data <- left_join(FW_Zweit_data, FW_DiffProzent, by= "Wahlkreis.Nr")

# Added Logic column if or if not FW in state parliament (RP= 7, BY=9)
FW_Diff_Data <- FW_Diff_Data %>% 
  mutate(is.LT= ifelse(.$Bundesland.Nr%in% c(7,9), TRUE, FALSE))

FW_Diff_Data$is.LT <- as.factor(FW_Diff_Data$is.LT)
```

## Bundesmap FW Stimmen
```{r}
p1 <- FW_Diff_Data %>%
  summarise(geometry= geometry, FW.Zweit.End.Perc= FW.Zweit.End.Perc*100) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= FW.Zweit.End.Perc))+
  scale_fill_continuous(name= "Anteil der Zweitstimmen in Prozent",low= "white", high= "orange", limit= c(0,15))+
  geom_sf(data = länder, color = "black", fill = NA)+
  ggtitle("Anteil der Zweitstimmen für die Freien Wähler (in %)")+
  labs(subtitle= "Bayern: Regierungsbeteiligung, Rheinland-Pfalz: Landtagsvertretung", caption = "NO")+
  theme_map()

ggsave("FW_ZweitPerc_Map.png", path = "Grafiken/", width = 7, height= 7)
```


## Boxplots DiffProzentPkt und Zweit Prozent 
```{r}


FW_Diff_Data %>% 
ggplot(aes(x= is.LT, y= DiffProzentPkt))+
  geom_boxplot()
ggsave("LT_FW_DiffPkt_Box.png", path = "Grafiken/", width = 7, height= 7)

FW_Diff_Data %>% 
ggplot(aes(x= is.LT, y= FW.Zweit.End.Perc))+
  geom_boxplot()


ggsave("LT_FW_ZweitPerc_Box.png", path = "Grafiken/", width = 7, height= 7)
```

## Korrelationsanalyse Freie Wähler
```{r}
cor_matrix_FW <- cor(select(FW_Diff_Data,-c(1:21,26,76,79)))

cor_matrix_FW_melted <- melt(cor_matrix_FW)

# dev.off()
cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=reorder(Var2,-value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

cor_matrix_FW_melted_sliced <- cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Zweit.End.Perc")) %>% 
  arrange(desc(value)) %>% 
  slice(which(Var2 %in% c("Unternehmen.HW", "Schulab.mitMittSA", "SozPfli.LandW",
                    "Boden.SieduVerk", "Schulab.mitAllgHS", "SozPfli.ÖffPrivDienstl")))

cor_matrix_FW_melted_sliced %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=reorder(Var2,-value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))
ggsave("Kor_Matrix_FW_Struktur_Sliced.png", path = "Grafiken/", width = 7, height= 7)

HW <- FW_Diff_Data %>% 
  ggplot(aes(x= Unternehmen.HW, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja (Wahlkreis liegt in Bayern)"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("Anteil an Zweitstimmen für die Freien Wähler")+
  xlab("Handwerksunternehmen (je 1000 EW)")+
  labs(colour= "Regierungsbeteiligung")
  
MittSA <- FW_Diff_Data %>% 
  ggplot(aes(x= Schulab.mitMittSA, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja (Wahlkreis liegt in Bayern)"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Schulabgänger/-innen mit 
       mittlerem Schulabschluss in Prozent")+
  labs(colour= "Regierungsbeteiligung in Prozent")

SozPfli.LandW <- FW_Diff_Data %>% 
  ggplot(aes(x= SozPfli.LandW, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja (Wahlkreis liegt in Bayern)"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Sozialversicherungspflichtige Beschäftigte 
  Land- und Forstwirtschaft, 
       Fischerei in Prozent")+
  labs(colour= "Regierungsbeteiligung")

Boden.SieduVerk <- FW_Diff_Data %>% 
  ggplot(aes(x= Boden.SieduVerk, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja (Wahlkreis liegt in Bayern)"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Bodenflächennutzung
       Siedlung und Verkehr in Prozent")+
  labs(colour= "Regierungsbeteiligung")
  
Schulab.mitAllgHS <- FW_Diff_Data %>% 
  ggplot(aes(x= Schulab.mitAllgHS, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja (Wahlkreis liegt in Bayern)"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Schulabgänger/-innen mit 
       allgemeiner und Fachhochschulreife in Prozent")+
  labs(colour= "Regierungsbeteiligung")

SozPfli.ÖffPrivDienstl <- FW_Diff_Data %>% 
  ggplot(aes(x= SozPfli.ÖffPrivDienstl, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja (Wahlkreis liegt in Bayern)"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Sozialversicherungspflichtige - 
       Öffentliche und private Dienstleister in Prozent")+
  labs(colour= "Regierungsbeteiligung")

p1 <- ggarrange(HW, MittSA,SozPfli.LandW, common.legend = TRUE, legend = "right", nrow= 1)
ggsave("LT_FW_ZweitPerc_Scatter_PosKor.png", path = "Grafiken/", width = 15, height= 7)

p1 <- ggarrange(Boden.SieduVerk, Schulab.mitAllgHS, SozPfli.ÖffPrivDienstl, nrow = 1,common.legend = TRUE, legend = "right")

ggsave("LT_FW_ZweitPerc_Scatter_NegKor.png", path = "Grafiken/", width = 15, height= 7)
```


# Hang zu extremen Randparteien (LINKE und AFD) speziell im Osten?

```{r}
p1 <- btw_trimmed_geo_data %>% 
  mutate(Rand.Zweit.End.Perc= LINKE.Zweit.End.Perc + AFD.Zweit.End.Perc) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= Rand.Zweit.End.Perc),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_viridis(option= "magma", trans= "reverse")

ggsave("Randparteien_Bund_Map.png", path = "Grafiken/", width= 7, height= 7)
```



# Korrelationenen Struktur in den neuen Bundesländern AFD

```{r}
AFD_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,AFD.Erst.End.Perc,AFD.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) %>%
  filter(Bundesland.Nr %in% 10:16)

cor_matrix_AFD <- cor(AFD_struktur, use= "complete", method = "spearman") 
cor_matrix_AFD_melted <- melt(cor_matrix_AFD) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_AFD_melted %>% 
  filter(Var1 %in% c("AFD.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))
```

# Korrelationenen Struktur in den neuen Bundesländern LINKE

```{r}
LINKE_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,LINKE.Erst.End.Perc, LINKE.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) %>%
  filter(Bundesland.Nr %in% 10:16)

cor_matrix_LINKE <- cor(LINKE_struktur, use= "complete", method = "spearman") 
cor_matrix_LINKE_melted <- melt(cor_matrix_LINKE) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_LINKE_melted %>% 
  filter(Var1 %in% c("LINKE.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust= 1))
```



## Ü60 AFD Scatterplot (WEST/OST)
```{r}
btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f75tInf.Perctange, col= is.Osten))+
  geom_point(alpha= 0.5)

btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f75tInf.Perctange, col= is.Berlin))+
  facet_wrap(~is.Osten)+
  geom_point(alpha= 0.5)

btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
  mutate(f60tInf.Perctange= f60t74.Perctange+f75tInf.Perctange) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f60tInf.Perctange, col= is.Berlin))+
  facet_wrap(~is.Osten)+
  geom_point(alpha= 0.5)
  
ggsave("AFD_ue60_O-W_Sctter.png", path = "Grafiken/", width= 7, height= 7)
```

## Ü60 Randparteien Scatterplot OST/WEST
```{r}
btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(10:16)) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
  mutate(Rand.Zweit.End.Perc= LINKE.Zweit.End.Perc + AFD.Zweit.End.Perc) %>% 
  mutate(f60tInf.Perctange= f60t74.Perctange+f75tInf.Perctange) %>% 
ggplot(aes(y= Rand.Zweit.End.Perc, x= f60tInf.Perctange, col= is.Berlin))+
  facet_wrap(~is.Osten)+
  geom_point(alpha= 0.25)

ggsave("Rand_ue60_O-W_Sctter.png", path = "Grafiken/", width= 7, height= 7)
```


# Hilfsgrafiken für Argumentation etc,
## Heatmap Korrelationsmatrix Strukturvariablen 

```{r}
struktur_only <- btw_trimmed_data %>% 
  select(76:ncol(btw_trimmed_data))

cor_matrix <- cor(struktur_only, use= "pairwise.complete.obs")

cor_matrix_melted <- melt(cor_matrix)

# dev.off()
limit <- max(abs(cor_matrix_melted$value)) * c(-1, 1)


ggplot(data = cor_matrix_melted, aes(x=Var1, y=Var2, fill=value)) + 
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))+
  ggtitle("Korrelationsmatrix der Strukturvariablen")

ggsave("Korr_Matrix_Strukturvariablen.png", path = "Grafiken/", width = 7, height= 7)
```

## Kormatrix SPD
```{r}
SPD_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,SPD.Erst.End.Perc,SPD.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) 

cor_matrix_SPD <- cor(SPD_struktur, use= "pairwise") 
cor_matrix_SPD_melted <- melt(cor_matrix_SPD) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_SPD_melted %>% 
  filter(Var1 %in% c("SPD.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

ggsave("Kor_Matrix_SPD_Struktur.png", path = "Grafiken/", width = 7, height= 7)
```

## Kormatrix Union
```{r}
UNION_struktur <- btw_trimmed_geo_data %>% 
  replace(is.na(.), 0) %>% 
  mutate(UNION.Erst.End.Perc= CDU.Erst.End.Perc + CSU.Erst.End.Perc, 
         UNION.Zweit.End.Perc= CDU.Zweit.End.Perc + CSU.Zweit.End.Perc) %>% 
  select(Bundesland.Nr ,UNION.Erst.End.Perc,UNION.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) 
  
cor_matrix_UNION <- cor(UNION_struktur, use= "complete") 
cor_matrix_UNION_melted <- melt(cor_matrix_UNION) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_UNION_melted %>% 
  filter(Var1 %in% c("UNION.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))

ggsave("Kor_Matrix_UNION_Struktur.png", path = "Grafiken/", width = 7, height= 7)
```

# Korrlationsscatterplots Strukturvariablen

```{r}
struktur_only <- btw_trimmed_data %>% 
  select(76:ncol(btw_trimmed_data))

colSums(is.na(struktur_only))

ggpairs(struktur_only[1:10],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[11:20],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[21:30],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[31:40],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
ggpairs(struktur_only[41:48],
        lower = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
        upper = list(continuous = wrap("cor", method = "spearman")))
```