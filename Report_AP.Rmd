---
title: 'Bundestagswahl 2021: Analyse des Wahlverhalten in Abhängigkeit von soziodemographischen
  Strukturmerkmalen'
author: "Carla Fuchs, Christian Hobelsberger, Max Melchior Lang, Mattia Mohr"
date: "10/30/2021"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(GGally)
library(reshape2)
library(RColorBrewer)
library(viridis)
library(ggpubr)
library(colorspace)

#loading cleaned data sets
btw_data <- readRDS("btw_data.RDS")
btw_trimmed_data <- readRDS("btw_trimmed_data.RDS")
btw_kerg_trimmed_bundeslaender <- readRDS("btw_kerg_trimmed_bundeslaender.RDS")
btw_kerg2_wk <- readRDS("btw_kerg2_wk.RDS")
länder <- st_read("Raw Data/laender_geometrie_WGS84/Bundeslaendergrenzen_2018.shp")
btw_kerg2_bund <- readRDS("btw_kerg2_bund.RDS")
#loading geo data
wk_path <- "Raw Data/btw21_geometrie_wahlkreise_geo_shp_WGS84/Geometrie_Wahlkreise_20DBT_geo.shp"
wk_shp <- st_read(wk_path)
glimpse(wk_shp)

# Loading  Mail and in Person voting Data from Bavaria
btw_brief_urne_all <- readRDS("btw_brief_urne_all.RDS")
btw_by_brief_urne_wk21 <- readRDS("btw_by_brief_urne_wk.RDS")
btw_by_brief_urne_Gde21 <- readRDS("btw_by_brief_urne_Gde.RDS")
wk_shp$LAND_NR <- NULL
wk_shp$LAND_NAME <- NULL

# joining
btw_geo_data <- left_join(btw_data, wk_shp, by= c("Wahlkreis.Nr" = "WKR_NR"))
btw_trimmed_geo_data <- left_join(btw_trimmed_data, wk_shp, by= c("Wahlkreis.Nr" = "WKR_NR"))
btw_trimmed_geo_data2 <- left_join(btw_trimmed_geo_data, btw_kerg2_wk, by= "Wahlkreis.Nr")
btw_geo_data$WKR_NAME <- NULL
btw_trimmed_geo_data$WKR_NAME <- NULL

# editing data

# Adding Union-Cols
btw_kerg_trimmed_bundeslaender[is.na(btw_kerg_trimmed_bundeslaender)] <- 0
btw_kerg_trimmed_bundeslaender <- btw_kerg_trimmed_bundeslaender %>%
  mutate(Union.Erst.Vor = CDU.Erst.Vor + CSU.Erst.Vor,
         Union.Erst.End = CDU.Erst.End + CSU.Erst.End,
         Union.Erst.End.Perc = CDU.Erst.End.Perc + CSU.Erst.End.Perc,
         Union.Zweit.Vor = CDU.Zweit.Vor + CSU.Zweit.Vor,
         Union.Zweit.End = CDU.Zweit.End + CSU.Zweit.End,
         Union.Zweit.End.Perc = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc)

btw_trimmed_data[is.na(btw_trimmed_data)] <- 0
btw_trimmed_data <- btw_trimmed_data %>%
  mutate(Union.Erst.Vor = CDU.Erst.Vor + CSU.Erst.Vor,
         Union.Erst.End = CDU.Erst.End + CSU.Erst.End,
         Union.Erst.End.Perc = CDU.Erst.End.Perc + CSU.Erst.End.Perc,
         Union.Zweit.Vor = CDU.Zweit.Vor + CSU.Zweit.Vor,
         Union.Zweit.End = CDU.Zweit.End + CSU.Zweit.End,
         Union.Zweit.End.Perc = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         Union.Erst.Zweit.Diff.Perc = Union.Erst.End.Perc - Union.Zweit.End.Perc,
         SPD.Erst.Zweit.Diff.Perc = SPD.Erst.End.Perc - SPD.Zweit.End.Perc,
         AFD.Erst.Zweit.Diff.Perc = AFD.Erst.End.Perc - AFD.Zweit.End.Perc,
         GRÜNE.Erst.Zweit.Diff.Perc = GRÜNE.Erst.End.Perc - GRÜNE.Zweit.End.Perc,
         FDP.Erst.Zweit.Diff.Perc = FDP.Erst.End.Perc - FDP.Zweit.End.Perc,
         LINKE.Erst.Zweit.Diff.Perc = LINKE.Erst.End.Perc - LINKE.Zweit.End.Perc,
         FW.Erst.Zweit.Diff.Perc = FW.Erst.End.Perc - FW.Zweit.End.Perc,
         Sonstige.Erst.Zweit.Diff.Perc = Sonstige.Erst.End.Perc - Sonstige.Zweit.End.Perc)

# Partei Farben
partein_fuer_farben <- c("CDU/CSU", "SPD", "AFD", "FDP", "Linke", "Grüne", "Sonstige")
partei_colors <- c("#32302e", "#E3000F", "#0099ff", "#ffed00", "#D23C77", "#46962b", "darkgrey")
names(partei_colors) <- partein_fuer_farben


theme_set(theme_light())

theme_map <- function(...) {
  theme_minimal() +
  theme(
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}
```



# Carla

# Strukturvariablen Scatterplots

```{r}

# Arbeitslosigkeit SPD

btw_trimmed_data %>%
  ggplot(aes(x = ArbeitslosQ / 100, y = SPD.Zweit.End.Perc)) +
  geom_jitter(fill = partei_colors["SPD"], shape = 21, alpha = 0.4) +
  labs(title = "Arbeitslosenquote und Zweitstimmen SPD") +
  xlab("Arbeitslosenquote* (in %)") +
  ylab("Zweitstimmen SPD (in %)") +
  labs(caption = "* Stand: Februar 2021") +
  scale_y_continuous(labels = scales::percent, limits = c(0, 0.5)) +
  scale_x_continuous(labels = scales::percent, limits = c(0, 0.16))


ggsave("Scatterplots_ArbeitslosQ_SPD.png", path = "Grafiken/", height = 6, width = 6)

ausreisser_spd <- select(filter(btw_trimmed_data, ArbeitslosQ == max(ArbeitslosQ)), Gebiet, ArbeitslosQ)
ausreisser_spd2 <- select(filter(btw_trimmed_data, SPD.Zweit.End.Perc == max(SPD.Zweit.End.Perc)), Gebiet, SPD.Zweit.End.Perc)


# Verfügbares Einkommen CDU

btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc) %>%
  ggplot(aes(x = Vfg.Einkommen, y = UNION)) +
  geom_jitter(fill = partei_colors["CDU/CSU"], shape = 21, alpha = 0.4) +
  labs(title = "Verfügbares Einkommen und Zweitstimmen Union") +
  xlab("Verfügbares Einkommen der privaten Haushalte* (EUR je EW)") +
  ylab("Zweitstimmen Union (in %)") +
  labs(caption = "* Stand: 2018") +
  scale_y_continuous(labels = scales::percent, limits = c(0, 0.5))

ggsave("Scatterplots_Vermögen_Union.png", path = "Grafiken/", height = 6, width = 6)

ausreisser_union <- select(filter(btw_trimmed_data, Vfg.Einkommen>30000), Gebiet, Vfg.Einkommen, CDU.Zweit.End.Perc, CSU.Zweit.End.Perc)

# Verfügbares Einkommen

partei_colors_carla <- partei_colors[1:6]
names(partei_colors_carla) <- NULL

btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         SPD = SPD.Zweit.End.Perc,
         GRÜNE = GRÜNE.Zweit.End.Perc,
         FDP = FDP.Zweit.End.Perc,
         AFD = AFD.Zweit.End.Perc,
         LINKE = LINKE.Zweit.End.Perc) %>%
  select(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE,
           Vfg.Einkommen)) %>%
  pivot_longer(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE), names_to = "Parteien", values_to = "Percentage") %>%
  mutate(Parteien = factor(Parteien, levels = c("UNION", "SPD", "AFD", "FDP", "LINKE", "GRÜNE"))) %>%
  ggplot(aes(x = Vfg.Einkommen, y = Percentage, fill = Parteien)) +
  geom_jitter(size = 1.75, shape = 21, alpha = 0.4) +
  facet_wrap("Parteien") +
  scale_fill_manual(values = partei_colors_carla) +
  theme(legend.position = "none") +
  labs(title = "Verfügbares Einkommen und Zweitstimmen je Partei") +
  xlab("Verfügbares Einkommen der privaten Haushalte* \n(in Euro je Einwohner)") +
  ylab("Zweitstimmen (in %)") +
  labs(caption = "* Stand: 2018") +
  scale_y_continuous(labels = scales::percent)

ggsave("Scatterplots_Vermögen.png", path = "Grafiken/", width = 9, height = 7)

# östliche Bundesländer

is_Osten_data <- btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         SPD = SPD.Zweit.End.Perc,
         GRÜNE = GRÜNE.Zweit.End.Perc,
         FDP = FDP.Zweit.End.Perc,
         AFD = AFD.Zweit.End.Perc,
         LINKE = LINKE.Zweit.End.Perc,
         f18t34.Perctange = f18t24.Perctange + f25t34.Perctange,
         is.Osten = case_when(Bundesland.Nr %in% c(12:16) ~ "östliche Bundesländer",
                              Bundesland.Nr %in% c(1:11) ~ "westliche Bundesländer")) %>%
  select(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE,
           Vfg.Einkommen, f18t34.Perctange, is.Osten, Gebiet)) %>%
  pivot_longer(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE), names_to = "Parteien", values_to = "Percentage") %>%
  mutate(Parteien = factor(Parteien, levels = c("UNION", "SPD", "AFD", "FDP", "LINKE", "GRÜNE")))

ggplot(is_Osten_data, aes(x = Vfg.Einkommen, y = Percentage, col = Parteien)) +
  geom_jitter(size = 1.75, color = "grey") +
  facet_wrap("Parteien") +
  geom_jitter(data = filter(is_Osten_data, is.Osten == "östliche Bundesländer"), aes(x = Vfg.Einkommen, y = Percentage, col = Parteien), size = 1.75) +
  scale_color_manual(values =  partei_colors_carla) +
  theme(legend.position = "none") +
  labs(title = "Verfügbares Einkommen und Zweitstimmen je Partei (östliche Bundesländer farbig)") +
  xlab("Verfügbares Einkommen der privaten Haushalte* \n(in Euro je Einwohner)") +
  ylab("Zweitstimmen (in %)") +
  labs(caption = "* Stand: 2018") +
  scale_y_continuous(labels = scales::percent)

ggsave("Scatterplots_Vermögen_Osten.png", path = "Grafiken/", width = 9, height = 7)


# Junge Wählerschaft Grüne

a <- btw_trimmed_data %>%
  mutate(f18t34.Perctange = f18t24.Perctange + f25t34.Perctange) %>%
  ggplot(aes(x = f18t34.Perctange, y = GRÜNE.Zweit.End.Perc)) +
  geom_jitter(colour = "green") +
  labs(title = "Alter von 18 bis 34") +
  xlab("Alter von 18 bis 34 (%) (Stand 31.12.2019)") +
  ylab("Zweitstimmen (%)")

# Junge Wählerschaft

btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         SPD = SPD.Zweit.End.Perc,
         GRÜNE = GRÜNE.Zweit.End.Perc,
         FDP = FDP.Zweit.End.Perc,
         AFD = AFD.Zweit.End.Perc,
         LINKE = LINKE.Zweit.End.Perc,
         f18t34.Perctange = f18t24.Perctange + f25t34.Perctange) %>%
  select(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE,
           f18t34.Perctange)) %>%
  pivot_longer(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE), names_to = "Parteien", values_to = "Percentage") %>%
  mutate(Parteien = factor(Parteien, levels = c("UNION", "SPD", "AFD", "FDP", "LINKE", "GRÜNE"))) %>%
  ggplot(aes(x = f18t34.Perctange, y = Percentage, fill = Parteien)) +
  geom_jitter(size = 1.75, shape = 21, alpha = 0.4) +
  facet_wrap("Parteien") +
  scale_fill_manual(values = partei_colors_carla) +
  theme(legend.position = "none") +
  labs(title = "Anteil der 18- bis 34-Jährigen und Zweitstimmen je Partei") +
  xlab("Anteil der 18- bis 34-Jährigen an der Gesamtbevölkerung* (in %)") +
  ylab("Zweitstimmen (in %)") +
  scale_y_continuous(labels = scales::percent) +
  labs(caption = "* Stand 31.12.2019")

ggsave("Scatterplots_Alter_f18t34.png", path = "Grafiken/", width = 9, height = 7)

# Junge Wählerschaft Osten

ggplot(is_Osten_data, aes(x = f18t34.Perctange, y = Percentage, col = Parteien)) +
  geom_jitter(size = 1.75, color = "grey") +
  facet_wrap("Parteien") +
  geom_jitter(data = filter(is_Osten_data, is.Osten == "östliche Bundesländer"), aes(x = f18t34.Perctange, y = Percentage, col = Parteien), size = 1.75) +
  scale_color_manual(values = partei_colors_carla) +
  theme(legend.position = "none") +
  labs(title = "Anteil der 18- bis 34-Jährigen und Zweitstimmen je Partei (östliche Bundesländer farbig)") +
  xlab("Anteil der 18- bis 34-Jährigen an der Gesamtbevölkerung* (in %)") +
  ylab("Zweitstimmen (in %)") +
  scale_y_continuous(labels = scales::percent) +
  labs(caption = "* Stand 31.12.2019")

ggsave("Scatterplots_Alter_f18t34_Osten.png", path = "Grafiken/", width = 9, height = 7)

# Bevölkerung Ausländer

btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         SPD = SPD.Zweit.End.Perc,
         GRÜNE = GRÜNE.Zweit.End.Perc,
         FDP = FDP.Zweit.End.Perc,
         AFD = AFD.Zweit.End.Perc,
         LINKE = LINKE.Zweit.End.Perc) %>%
  select(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE,
           Bvk.Aus)) %>%
  pivot_longer(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE), names_to = "Age", values_to = "Percentage") %>%
  ggplot(aes(x = Percentage, y = Bvk.Aus, col = Age)) +
  geom_jitter() +
  facet_wrap("Age") +
  scale_color_manual(values = c("blue", "yellow", "green", "purple", "red", "black")) +
  theme(legend.position = "none") +
  labs(title = "Bevölkerung Ausländer") +
  xlab("Zweitstimmen (%)") +
  ylab("Bevölkerung Ausländer in 1000 (Stand 31.12.2019)")

ggsave("Scatterplots_Ausländer.png", path = "Grafiken/")


# Ü 34 Wählerschaft

btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         SPD = SPD.Zweit.End.Perc,
         GRÜNE = GRÜNE.Zweit.End.Perc,
         FDP = FDP.Zweit.End.Perc,
         AFD = AFD.Zweit.End.Perc,
         LINKE = LINKE.Zweit.End.Perc,
         f34tInf.Perctange = f35t59.Perctange + f60t74.Perctange + f75tInf.Perctange) %>%
  select(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE,
           f34tInf.Perctange)) %>%
  pivot_longer(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE), names_to = "Age", values_to = "Percentage") %>%
  ggplot(aes(x = Percentage, y = f34tInf.Perctange, col = Age)) +
  geom_jitter() +
  facet_wrap("Age") +
  scale_color_manual(values = c("blue", "yellow", "green", "purple", "red", "black")) +
  theme(legend.position = "none") +
  labs(title = "Alter ab 35") +
  xlab("Zweitstimmen (%)") +
  ylab("Alter ab 35 (%) (Stand 31.12.2019)")

ggsave("Scatterplots_Alter_f35tInf.png", path = "Grafiken/")

# Bevölkerungsdichte

btw_trimmed_data %>%
  replace(is.na(.), 0) %>%
  mutate(UNION = CDU.Zweit.End.Perc + CSU.Zweit.End.Perc,
         SPD = SPD.Zweit.End.Perc,
         GRÜNE = GRÜNE.Zweit.End.Perc,
         FDP = FDP.Zweit.End.Perc,
         AFD = AFD.Zweit.End.Perc,
         LINKE = LINKE.Zweit.End.Perc) %>%
  select(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE,
           Bvk.Dcht)) %>%
  pivot_longer(c(UNION, SPD, GRÜNE, FDP, AFD, LINKE), names_to = "Age", values_to = "Percentage") %>%
  ggplot(aes(x = Percentage, y = Bvk.Dcht, col = Age)) +
  geom_jitter() +
  facet_wrap("Age") +
  scale_color_manual(values = c("blue", "yellow", "green", "purple", "red", "black")) +
  theme(legend.position = "none") +
  labs(title = "Bevölkerungsdichte") +
  xlab("Zweitstimmen (%)") +
  ylab("Bevölkerungsdichte EW je km^2 (Stand 31.12.2019)")

ggsave("Scatterplots_Bevölkerungsdichte.png", path = "Grafiken/")
```

# Chris
```{r}

# Data Structuring: Making a clean Data Frame

ergebnisse_diff_table <- btw_kerg2_bund %>%
  filter(Stimme == 2) %>%
  filter(Gruppenname %in% c("CDU", "CSU", "SPD", "AfD", "FDP", "DIE LINKE", "GRÜNE"))

ergebnisse_diff_table[["DiffProzentPkt"]] <- as.numeric(ergebnisse_diff_table[["DiffProzentPkt"]])

anzahl_stimmen_erst <- sum(btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Erst.End"]])

anzahl_stimmen_zweit <- sum(btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Zweit.End"]])

anzahl_stimmen_gesamt <- sum(btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Erst.End"]] + btw_kerg_trimmed_bundeslaender[["Gültige.Stimmen.Zweit.End"]])


partei <- c("CDU/CSU", "SPD", "AFD", "FDP", "Linke", "Grüne", "Sonstiges")
stimmen_gesamt <- c(
  sum(btw_kerg_trimmed_bundeslaender[["Union.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["Union.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Erst.End"]]) +
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Zweit.End"]]),
  0
  )

stimmen_erst <- c(
  sum(btw_kerg_trimmed_bundeslaender[["Union.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Erst.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Erst.End"]]),
  0
  )
stimmen_zweit <- c(
  sum(btw_kerg_trimmed_bundeslaender[["Union.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["SPD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["AFD.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["FDP.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["LINKE.Zweit.End"]]),
  sum(btw_kerg_trimmed_bundeslaender[["GRÜNE.Zweit.End"]]),
  0
  )

stimmen_zweit_diff_perc <- c(
  sum(ergebnisse_diff_table[1,17], ergebnisse_diff_table[7,17]),
  ergebnisse_diff_table[2:6, 17],
  0
)


ergebnisse_table <- data.frame(partei, stimmen_erst, stimmen_zweit, stimmen_gesamt)

ergebnisse_table[7,2] <- anzahl_stimmen_erst - sum(ergebnisse_table[1:6,2])

ergebnisse_table[7,3] <- anzahl_stimmen_zweit - sum(ergebnisse_table[1:6,3])

ergebnisse_table[7,4] <- anzahl_stimmen_gesamt - sum(ergebnisse_table[1:6,4])

ergebnisse_table <- ergebnisse_table %>%
  mutate(stimmen_erst_perc = stimmen_erst / anzahl_stimmen_erst,
         stimmen_zweit_perc = stimmen_zweit / anzahl_stimmen_zweit,
         stimmen_gesamt_perc = stimmen_gesamt/ anzahl_stimmen_gesamt)

ergebnisse_table[["partei"]] <- factor(ergebnisse_table[["partei"]], levels = ergebnisse_table[["partei"]])

ergebnisse_table <- cbind(ergebnisse_table, stimmen_zweit_diff_perc)

ergebnisse_table
  


```

# Ergebnisse Bundestagswahl 2021
```{r}
ergebnis_erststimmen <- ergebnisse_table %>%
  ggplot(mapping = aes(x = partei, y = stimmen_erst_perc)) +
  geom_bar(stat = "identity", fill = partei_colors) +
  xlab("Partei") +
  ylab("Erststimmenanteil (in %)") +
  ggtitle(label = "Endgültige Erststimmen der Bundestagswahl 2021") +
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::pretty_breaks(n = 10),
                     limits = c(0,0.3))
  
  ggsave("Ergebnis_Erststimmen.png", path="Grafiken/", width = 7, height= 7)
  
ergebnis_zweitstimmen <- ergebnisse_table %>%
  ggplot(mapping = aes(x = partei, y = stimmen_zweit_perc)) +
  geom_bar(stat = "identity", fill = partei_colors) +
  xlab("Partei") +
  ylab("Zweitstimmenanteil (in %)") +
  ggtitle(label = "Endgültige Zweitstimmen der Bundestagswahl 2021") +
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::pretty_breaks(n = 10),
                     limits = c(0,0.3))
ggsave("Ergebnis_Zweitstimmen.png", path="Grafiken/", width = 7, height= 7)

diff_zweitstimmen <- ergebnisse_table %>%
  slice(-7) %>%
  ggplot(mapping = aes(x = partei, 
                       y = stimmen_zweit_diff_perc/100)) +
  geom_bar(stat = "identity", fill = partei_colors[1:6]) +
  xlab("Partei") +
  ylab("Differenz der Zweitstimmen zur BTW 2017 (in Prozentpunkten)") +
  ggtitle(label = "Differenz an Prozentpunkten der Zweitstimmen \nzwischen der Bundestagswahl 2017 und 2021 je Partei") +
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::pretty_breaks(n = 10),
                     limits = c(-0.1, 0.1)) +
  labs(caption = "BTW: Bundestagswahl")

ggsave("Differenzen_Zweitstimmen.png", path="Grafiken/", width = 7, height= 7)

ggarrange(ergebnis_erststimmen, ergebnis_zweitstimmen, ncol = 1)

ggsave("Ergebnis_UND_Zweitstimmen.png", path="Grafiken/", width = 7, height= 7)

```


# Mattia
```{r}
#Boxplot Differenz Erst - Zweitstimmen pro Partei
ez_union <- btw_trimmed_data %>%
  ggplot()+
  geom_boxplot(aes(x = "UNION", y = Union.Erst.Zweit.Diff.Perc), fill = "black",
               color = "darkgrey", outlier.color = "black", size = 1.02)+
  labs(x = NULL)+
  scale_y_continuous(limits = c(-0.1, 0.2))
ez_spd <- btw_trimmed_data %>%
  ggplot()+
  geom_boxplot(aes(x = "SPD", y = SPD.Erst.Zweit.Diff.Perc), fill = "red")+
  labs(x = NULL)
ez_afd <- btw_trimmed_data %>%
  ggplot()+
  geom_boxplot(aes(x = "AFD", y = AFD.Erst.Zweit.Diff.Perc), fill = "blue")+
  labs(x = NULL)
ez_gruene <- btw_trimmed_data %>%
  ggplot()+
  geom_boxplot(aes(x = "GRÜNE", y = GRÜNE.Erst.Zweit.Diff.Perc),fill = "green")+
  labs(x = NULL)+
  scale_y_continuous(limits = c(-0.1, 0.2))
ez_fdp <- btw_trimmed_data %>%
  ggplot()+
  geom_boxplot(aes(x = "FDP", y = FDP.Erst.Zweit.Diff.Perc), fill = "yellow")+
  labs(x = NULL, y = "Stimmen mehr Erststimmen als Zweitstimmen in %", title = "Erst- und Zweitstimmen der Wahlkreise pro Partei")
ez_linke <- btw_trimmed_data %>% 
  ggplot()+
  geom_boxplot(aes(x = "LINKE", y = LINKE.Erst.Zweit.Diff.Perc), fill = "purple")+
  labs(x= NULL)+
  scale_y_continuous(limits = c(-0.1, 0.2))
ggarrange(ez_union, ez_gruene, ez_linke, nrow = 1)
ggarrange(ez_spd, ez_fdp, ez_afd, nrow = 1)


#Scatterplot Zusammenhang Erst-Zweitstimmen pro Partei
ezd_union <- btw_trimmed_data %>%
  ggplot()+
  geom_abline(linetype = "longdash", color = "#666666")+
  geom_point(aes(x = Union.Erst.End.Perc, y = Union.Zweit.End.Perc), fill = partei_colors["CDU/CSU"], color = "black", shape = 21, alpha = 0.5)+
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 0.55), position = "bottom")+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.55))+
  labs(x = "Erststimmanteile (in %)", y = "Zweitstimmanteile (in %)") +
  ggtitle("UNION")
ezd_spd <- btw_trimmed_data %>%
  ggplot()+
  geom_abline(linetype = "longdash", color = "#666666")+
  geom_point(aes(x = SPD.Erst.End.Perc, y = SPD.Zweit.End.Perc), shape = 21, fill = partei_colors["SPD"], color = "black", alpha = 0.5)+
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 0.55))+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.55))+
  labs(x = "Erststimmanteile (in %)", y = NULL) +
  ggtitle("SPD")
ezd_gruene <- btw_trimmed_data %>%
  ggplot()+
  geom_abline(linetype = "longdash", color = "#666666")+
  geom_point(aes(x = GRÜNE.Erst.End.Perc, y = GRÜNE.Zweit.End.Perc), shape = 21, fill = partei_colors["Grüne"], color = "black", alpha = 0.5)+
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  labs(x = NULL, y = "Zweitstimmanteile (in %)") +
  ggtitle("GRÜNE")
ezd_afd <- btw_trimmed_data %>%
  ggplot()+
  geom_abline(linetype = "longdash", color = "#666666")+
  geom_point(aes(x = AFD.Erst.End.Perc, y = AFD.Zweit.End.Perc), shape = 21, fill = partei_colors["AFD"], color = "black", alpha = 0.5)+
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  labs(x = "Erststimmanteile (in %)", y = "Zweitstimmanteile (in %)") +
  ggtitle("AFD")
ezd_fdp <- btw_trimmed_data %>%
  ggplot()+
  geom_abline(linetype = "longdash", color = "#666666")+
  geom_point(aes(x = FDP.Erst.End.Perc, y = FDP.Zweit.End.Perc), shape = 21, fill = partei_colors["FDP"], color = "black", alpha = 0.3)+
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  labs(x = NULL, y = NULL) +
  ggtitle("FDP")
ezd_linke <- btw_trimmed_data %>%
  ggplot()+
  geom_abline(linetype = "longdash", color = "#666666")+
  geom_point(aes(x = LINKE.Erst.End.Perc, y = LINKE.Zweit.End.Perc), shape = 21, fill = partei_colors["Linke"], color = "black", alpha = 0.5)+
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.4))+
  labs(x = "Erststimmanteile (in %)", y = NULL) +
  ggtitle("LINKE")
ggarrange(ezd_union, ezd_spd, ezd_gruene, ezd_fdp, ezd_afd, ezd_linke, label.y = c(rep(1, 6)), label.x = rep(0.3, 6))

MM_Erst_Zweit_CDU_SPD <- ggarrange(ezd_union, ezd_spd, label.y = c(rep(1, 6)), label.x = rep(0.3, 6))
annotate_figure(MM_Erst_Zweit_CDU_SPD, top = text_grob("Erststimmen vs. Zweitstimmen", color = "black", size = 14))

ggsave("MM_Erst_Zweit_CDU_SPD.png", path = "Grafiken", width = 9, height = 5)

MM_Erst_Zweit_Rest <- ggarrange(ezd_gruene, ezd_fdp, ezd_afd, ezd_linke, label.y = c(rep(1, 6)), label.x = rep(0.3, 6))
annotate_figure(MM_Erst_Zweit_Rest, top = text_grob("Erststimmen vs. Zweitstimmen", color = "black", size = 14))

ggsave("MM_Erst_Zweit_Rest.png", path = "Grafiken", width = 9, height = 9)

#ggsave("MM_Erst_Zweit_große_Parteien.png", path = "Grafiken", width = 9, height = 7)
```

# Max
# Dateneinführung
* Daten des Bundeswahlleiters
* 299 Wahlkreise als statistische Einheiten
* Zwei Datensätze: tabelarischen und flachen Aufbau
* Strukturdatensatz
* Strukturdaten für Wahlkreise enthalten Angaben über Gebiet und Bevölkerung, Flächennutzung, Unternehmensregister, Schulabgängerinnen und -abgänger beruflicher und allgemeinbildender Schulen, Kindertagesbetreuung, volkswirtschaftliche Gesamtrechnungen der Länder, sozialversicherungspflichtige Beschäftigte, Empfängerinnen und Empfängern von Leistungen nach SGB II und Arbeitslosenquoten.
* Strukturdaten stammen überwiegend aus der „Regionaldatenbank Deutschland“, einer Gemeinschaftsveröffentlichung der Statistischen Ämter des Bundes und der Länder.

* Besonderheiten
* Bei den Stadt*Bundesländern liegen die Daten häufig nur für das gesamte Bundesland vor und nicht auf Wahlkreisebene
* Kurze Erkärung des Wahlsystems:
* Jede wählende Person hat eine Erst- und eine Zweitstimme
* Die Erststimme wird für einen Direktkandidaten im jeweiligen Wahlkreis abgegeben, nur der/die Kandidat/Kandidatin mit meisten Stimmen kommt in den Bundestag
* Zweitstimmen werden für eine Partei abgegeben, diese wählt dann anhand einer Landesliste die Abgeordneten aus

* Verwendung zusätzlicher Daten für Erstellung von Karten

# Grafiken für den Vortrag
# SPD und Union (Gewinn Verluste) --> Vor: Soziodemografisch Union SPD
```{r}
spd_zweit <- btw_kerg2_wk %>% 
  filter(Gruppenname == "SPD") %>% 
  filter(Stimme == 2) %>% 
  arrange(Wahlkreis.Nr)

spd_erst <- btw_kerg2_wk %>% 
  filter(Gruppenname == "SPD") %>% 
  filter(Stimme == 1) 

cor(spd_erst$DiffProzentPkt, spd_zweit$DiffProzentPkt)

union_zweit <- btw_kerg2_wk %>% 
  filter(Gruppenname %in% c("CDU", "CSU")) %>% 
  filter(Stimme == 2) %>% 
  arrange(Wahlkreis.Nr)

union_erst <- btw_kerg2_wk %>% 
  filter(Gruppenname %in% c("CDU", "CSU")) %>% 
  filter(Stimme == 1)

cor(union_erst$DiffProzentPkt, union_zweit$DiffProzentPkt)

SPD_CDU_CSU_Diff <- rbind(union_zweit, spd_zweit) %>% 
  select(Gruppenname, DiffProzentPkt)

SPD_CDU_CSU_Diff[["Gruppenname"]][which(SPD_CDU_CSU_Diff[["Gruppenname"]]%in% c("CDU","CSU"))] <- "Union"

```

# Scatterplot Union-SPD Verlust
* Union hat keine Gewinne bei den Zweitstimmen erzielen können
* SPD konnte bis auf 3 Wahlkreise überall Zuwächse (Zweitstimmen) verzeichnen
* Wahlkreise in denen die Union starke Verluste hatte, hatte die SPD starke Zuwächse

* Stärksten Zuwächse bei SPD in:
* Mecklenburgische Seenplatte II – Landkreis Rostock III
* Ludwigslust-Parchim II – Nordwestmecklenburg II – Landkreis Rostock I

* Verluste der SPD:
* Aachen I und Aachen II + Düren

* Union geringste Verluste:
* Nürnberg-Süd, Aachen II, Gelsenkirchen

```{r}
data.frame(list(union_diff= union_zweit$DiffProzentPkt,
                spd_diff= spd_zweit$DiffProzentPkt,
                Wahlkreis.Nr= union_zweit$Wahlkreis.Nr)) %>% 
  ggplot(aes(x= union_diff/100, y= spd_diff/100))+
  geom_point(alpha= 0.7)+
  geom_hline(yintercept = 0, linetype= "dashed", colour= "black")+
  geom_vline(xintercept = 0, linetype= "dashed", colour= "black")+
  ggtitle("Differenz an Prozentpunkten der Zweitstimmen zwischen der\n Bundestagswahl 2017 und 2021 SPD und UNION")+
  xlab("UNION Differenz der Zweitstimmen (in Prozentpunkten)")+
  ylab("SPD Differenz der Zweitstimmen (in Prozentpunkten)")+
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::pretty_breaks(n = 10),
                     limits = c(-0.1, 0.2))+
  scale_x_continuous(labels = scales::percent,
                     limits = c(-0.2, 0.05))

ggsave("Zweit_Union_SPD_Diff_Scatter.png", path="Grafiken/", width = 7, height= 7)
```

### In welche Wahlkreisen hatte die SPD die stärksten Zuwächse?
```{r}
spd_zweit %>% 
  arrange(desc(DiffProzentPkt)) %>% 
  slice(1:5) %>% 
  select(Wahlkreis.Nr,Gebietsname, DiffProzentPkt)
```

### Welche Wahlkreise hatte die SPD einen Stimmverlust?
```{r}
spd_zweit %>% 
  slice(which(DiffProzentPkt<0))  %>% 
  select(Gebietsname, DiffProzentPkt)
```


### In welchen Wahlkreisen hatte die Union die stärksten Verluste?

```{r}
union_zweit %>% 
  arrange(DiffProzentPkt) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```

```{r}
union_erst %>% 
  arrange(DiffProzentPkt) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```

### In welchen Wahlkreisen hatte die Union die geringsten Verluste?
```{r}
union_zweit %>% 
  arrange(desc(DiffProzentPkt)) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```
### Bei den Erststimmen ?
```{r}
union_erst %>% 
  arrange(desc(DiffProzentPkt)) %>% 
  slice(1:5) %>% 
  select(Gebietsname, DiffProzentPkt)
```



## SPD Gewinn/Verlust Map und Union Verlust Map
* SPD v.a. Zuwächse in den neuen Bundesländern
* Union flächendeckende Verluste

```{r}

spd_GV <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= spd_zweit[["DiffProzentPkt"]] / 100),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_continuous_diverging(labels = scales::percent,
                                  name= "Differenz der Prozentpunkte",
                                  palette= "Blue-Yellow 2", limit= c(-0.2,0.2))+
  ggtitle("SPD")+
  xlab("")+
  ylab("")+
  theme_map()
ggsave("SPD_GV.png", path="Grafiken/", width = 9, height= 9)

union_GV <- btw_trimmed_geo_data %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= union_zweit$DiffProzentPkt / 100),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_continuous_diverging(labels = scales::percent,
                                  name= "Differenz der Prozentpunkte",
                                  palette= "Blue-Yellow 2", limit= c(-0.2,0.2))+
  ggtitle("UNION")+
  xlab("")+
  ylab("")+
  theme_map()

ggsave("Union_GV.png", path="Grafiken/", width = 9, height= 9)


SPD_Union_Zweit_GV_Map <- ggarrange(spd_GV, union_GV,
common.legend = TRUE, legend = "right", nrow= 1)
annotate_figure(SPD_Union_Zweit_GV_Map, top = text_grob("Differenz der Zweitstimmen zwischen Bundestagswahl 2017 und 2021 in Prozentpunkten für SPD und UNION", color = "black", size = 17, vjust = 4.5))

ggsave("SPD_Union_Zweit_GV_Map.png", path="Grafiken/", width = 14, height= 10)
```


# Briefwahl in Bayern 
## Data Preparation
```{r}
total_brief_urne <- btw_by_brief_urne_wk21 %>% 
  mutate(Urnenwaehler= B - B1Briefwähler) %>% 
  select(B, Urnenwaehler, B1Briefwähler) %>% 
  colSums()
names(total_brief_urne) <- c("Gesamt.Waehler", "Urnenwaehler", "Briefwaehler")

btw_21_17_brief_urne <- btw_brief_urne_all %>% 
  mutate(Urnenwaehler_21= B_21 - B1Briefwähler_21,
         Urnenwaehler_17= B_17 - B1Briefwähler_17) %>% 
  select(schluessel, B_21, B_17, B1Briefwähler_21, B1Briefwähler_17, Urnenwaehler_21, Urnenwaehler_17)


total_brief_urne_21_17 <- btw_21_17_brief_urne %>% 
  select(-schluessel) %>% 
  colSums()

total_brief_urne_21_17_df <- data.frame(list(Jahr= as.factor(c("2017", "2017", "2021", "2021")), 
                                             Art= as.factor(c("Urne", "Brief", "Urne", "Brief")), 
                                             Anzahl= c(total_brief_urne_21_17[c("Urnenwaehler_17","B1Briefwähler_17")], total_brief_urne_21_17[c("Urnenwaehler_21","B1Briefwähler_21")])))

total_brief_urne_21_17_df <-  total_brief_urne_21_17_df %>%
  add_column(Gesamt.Anzahl = c(rep(total_brief_urne_21_17[2],2), rep(total_brief_urne_21_17[1],2)))

total_brief_urne <- btw_by_brief_urne_wk21 %>% 
  mutate(Urnenwaehler= B - B1Briefwähler) %>% 
  select(B, Urnenwaehler, B1Briefwähler) %>% 
  colSums()
names(total_brief_urne) <- c("Gesamt.Waehler", "Urnenwaehler", "Briefwaehler")
```


## 2021 Barplot Absolut nach Art
```{r}
data.frame(list(Art= c("Urne", "Brief"), Anzahl= c(total_brief_urne[2], total_brief_urne[3]))) %>% 
  ggplot(aes(x= Art, y= Anzahl)) +
  geom_bar(stat= "identity") + 
  scale_y_continuous(breaks = seq(from= 0, to= 5000000, by= 500000), limits = c(0,5000000),
                     labels = c("0","500.000","1.000.000","1.500.000","2.000.000","2.500.000","3.000.000",
                                "3.500.000", "4.000.000","4.500.000","5.000.000"))+
  labs(title = "Anzahl der Wählenden nach Art (Brief/Urne) in Bayern" )

ggsave("Brief_Urne_Anzahl_BY_21.png", path="Grafiken/", width = 7, height= 7)

```

## Stacked scaled Barplot 2017 zum Vergleich der Anteile
```{r}
total_brief_urne_21_17_df %>% 
  mutate((Perc= Anzahl/Gesamt.Anzahl)) %>% 
  ggplot(aes(x= Jahr, y= Anzahl, fill= Art))+
  geom_bar(stat = "identity", position = "fill")+
  scale_fill_manual(values = c("#8dd3c7", "darkgrey"))+
  ggtitle("Vergleich der Anteile von Brief- und Urnenwahl zwischen 2017 und 2021")+
  ylab("Anteil der Wahlart (in %)") +
  scale_y_continuous(labels = scales::percent)

ggsave("Brief_Urne_ScaledBar_BY_1721.png", path="Grafiken/", width = 7, height= 7)
```

# Freie Wähler Landtagsbeteiligung + BTW
```{r}
cor(btw_trimmed_data$FW.Erst.End.Perc, btw_trimmed_data$FW.Zweit.End.Perc, use= "complete")

FW_DiffProzent <- btw_trimmed_geo_data2 %>% 
  filter(Gruppenname %in% "FREIE WÄHLER") %>% 
  filter(Stimme == 2) %>% 
  select(Wahlkreis.Nr, DiffProzent, DiffProzentPkt)

FW_Zweit_data <- btw_trimmed_geo_data %>% 
  select(-c(22:63)) %>% 
  select(-c(28:33))

FW_Diff_Data <- left_join(FW_Zweit_data, FW_DiffProzent, by= "Wahlkreis.Nr")

# Added Logic column if or if not FW in state parliament (RP= 7, BY=9)
FW_Diff_Data <- FW_Diff_Data %>% 
  mutate(is.LT= ifelse(.$Bundesland.Nr%in% c(7,9), TRUE, FALSE))

FW_Diff_Data$is.LT <- as.factor(FW_Diff_Data$is.LT)
```

## Bundesmap FW Stimmen
```{r}
FW_Diff_Data %>%
  summarise(geometry= geometry, FW.Zweit.End.Perc= FW.Zweit.End.Perc) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= FW.Zweit.End.Perc))+
  scale_fill_continuous(name= "Anteil der Zweitstimmen (in %)",low= "white", high= "orange", limit= c(0,0.18), labels = scales::percent)+
  geom_sf(data = länder, color = "black", fill = NA)+
  ggtitle("Anteil der Zweitstimmen für die Freien Wähler (in %)")+
  labs(subtitle= "Bayern: Regierungsbeteiligung, Rheinland-Pfalz: Landtagsvertretung") +
  theme_map()

ggsave("FW_ZweitPerc_Map.png", path = "Grafiken/", width = 7, height= 7)
```


## Boxplots DiffProzentPkt und Zweit Prozent 
```{r}
FW_Diff_Data %>% 
ggplot(aes(x= is.LT, y= DiffProzentPkt))+
  geom_boxplot()+
  scale_x_discrete(labels= c("Keine Landtagsvertretung", "Landtagsvertretung"))+
  xlab("")+
  ylab("Differenz der Prozentpunkte bei den Zweitstimmen")+
  labs(subtitle= "Bayern: Regierungsbeteiligung, Rheinland-Pfalz: Landtagsvertretung")+
  ggtitle("Differenz der Prozentpunkt bei den Zweitstimmen mit/ohne Landtagsvertretung")

ggsave("LT_FW_DiffPkt_Box.png", path = "Grafiken/", width = 7, height= 7)

FW_Diff_Data %>% 
ggplot(aes(x= is.LT, y= FW.Zweit.End.Perc))+
  geom_boxplot()+
  scale_x_discrete(labels= c("Keine Landtagsvertretung", "Landtagsvertretung"))+
  xlab("")+
  ylab("Anteil an Zweitstimmen")+
  labs(subtitle= "Bayern: Regierungsbeteiligung, Rheinland-Pfalz: Landtagsvertretung")+
  ggtitle("Anteil an Zweitstimmen mit/ohne Landtagsvertretung")


ggsave("LT_FW_ZweitPerc_Box.png", path = "Grafiken/", width = 7, height= 7)
```

## Korrelationsanalyse Freie Wähler
```{r}
cor_matrix_FW <- cor(select(FW_Diff_Data,-c(1:21,26,76,79)))

cor_matrix_FW_melted <- melt(cor_matrix_FW)

cor_matrix_FW_melted_sliced <- cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Zweit.End.Perc")) %>% 
  arrange(desc(value)) %>% 
  slice(which(Var2 %in% c("Unternehmen.HW", "Schulab.mitMittSA", "SozPfli.LandW",
                    "Boden.SieduVerk", "Schulab.mitAllgHS", "SozPfli.ÖffPrivDienstl")))+
  theme()

cor_matrix_FW_melted_sliced %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=reorder(Var2,-value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=0,hjust=0.5), legend.text = element_text("Wert Korrelation"))+
  labs(x = "", y = "", title = "Korrelation Zweitstimmenanteil für Freie Wähler \nund ausgewählte Strukturvariablen")
ggsave("Kor_Matrix_FW_Struktur_Sliced.png", path = "Grafiken/", width = 7, height= 7)

HW <- FW_Diff_Data %>%
  ggplot(aes(x= Unternehmen.HW, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("Anteil an Zweitstimmen (in %)")+
  xlab("\n\nHandwerksunternehmen (je 1000 Einwohner)")+
  labs(colour= "Bayern") +
  scale_y_continuous(labels = scales::percent)+
  ggtitle("Beispiel positiver Korrelation: Anteil an Zweitstimmen für freie Wähler und Anzahl Handwerksunternehmen")
  
ggsave("LT_FW_ZweitPerc_Scatter_HW.png", path = "Grafiken/", width = 10, height= 7)

MittSA <- FW_Diff_Data %>% 
  ggplot(aes(x= Schulab.mitMittSA/100, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("\nSchulabgänger/-innen mit 
       mittlerem Schulabschluss (in %)")+
  labs(colour= "Bayern") +
  scale_y_continuous(labels = scales::percent) + 
  scale_x_continuous(labels = scales::percent)

SozPfli.LandW <- FW_Diff_Data %>% 
  ggplot(aes(x= SozPfli.LandW/100, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Sozialversicherungspflichtige Beschäftigte 
  Land- und Forstwirtschaft, 
       Fischerei (in %)")+
  labs(colour= "Bayern") +
  scale_y_continuous(labels = scales::percent) + 
  scale_x_continuous(labels = scales::percent) +
  ggtitle("Beispiel positiver Korrelation: Anteil an Zweitstimmen für freie Wähler und Anteil\n                                                Sozialversicherungspflichtige Beschäftigte in Land- und Forstwirtschaft")

ggsave("LT_FW_ZweitPerc_Scatter_SozVersLandForst.png", path = "Grafiken/", width = 10, height= 7)

Boden.SieduVerk <- FW_Diff_Data %>% 
  ggplot(aes(x= Boden.SieduVerk/100, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("Anteil an Zweitstimmen (in %)")+
  xlab("Bodenflächennutzung
       Siedlung und Verkehr (in %)")+
  labs(colour= "Bayern") +
  scale_y_continuous(labels = scales::percent) + 
  scale_x_continuous(labels = scales::percent)+
  ggtitle("Beispiel negativer Korrelation: Anteil an Zweitstimmen für freie Wähler und Anteil Bodenflächennutzung\n                                                 durch Siedlung und Verkehr")

ggsave("LT_FW_ZweitPerc_Scatter_BodenflNutzung.png", path = "Grafiken/", width = 10, height= 7)
  
Schulab.mitAllgHS <- FW_Diff_Data %>% 
  ggplot(aes(x= Schulab.mitAllgHS/100, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Schulabgänger/-innen mit 
       allgemeiner und Fachhochschulreife (in %)")+
  labs(colour= "Bayern") +
  scale_y_continuous(labels = scales::percent) + 
  scale_x_continuous(labels = scales::percent)+
  ggtitle("Beispiel negativer Korrelation: Anteil an Zweitstimmen für freie Wähler und Anteil Schulabgänger/-innen\n                                                 mit allgemeiner und Fachhochschulreife")

ggsave("LT_FW_ZweitPerc_Scatter_HSAbschl.png", path = "Grafiken/", width = 10, height= 7)

SozPfli.ÖffPrivDienstl <- FW_Diff_Data %>% 
  ggplot(aes(x= SozPfli.ÖffPrivDienstl/100, y= FW.Zweit.End.Perc))+
  geom_point(aes(colour= ifelse(Bundesland.Nr %in% 9, "blue","black")),alpha= 0.5)+
  scale_colour_manual(values = c("black", "dodgerblue"),labels= c( "Nein","Ja"))+
  facet_wrap(~is.LT, labeller = labeller(is.LT = c("FALSE"="keine Landtagsvertretung", "TRUE"="Landtagsvertretung"))) +
  ylab("")+
  xlab("Sozialversicherungspflichtige - 
       Öffentliche und private Dienstleister (in %)")+
  labs(colour= "Bayern") +
  scale_y_continuous(labels = scales::percent) + 
  scale_x_continuous(labels = scales::percent)

p1 <- ggarrange(HW,SozPfli.LandW, common.legend = TRUE, legend = "top", nrow= 1)
annotate_figure(p1, top = text_grob("Beispiele positiver Korrelation: Anteil an Zweitstimmen für freie Wähle und ausgewählte Strukturvariablen", color = "black", size = 15))
ggsave("LT_FW_ZweitPerc_Scatter_PosKor.png", path = "Grafiken/", width = 15, height= 7)


p1 <- ggarrange(Boden.SieduVerk, Schulab.mitAllgHS, nrow = 1,common.legend = TRUE, legend = "top")
annotate_figure(p1, top = text_grob("Beispiele negativer Korrelation: Anteil an Zweitstimmen für Freie Wähler und ausgewählte Strukturvariablen", color = "black", size = 15))

ggsave("LT_FW_ZweitPerc_Scatter_NegKor.png", path = "Grafiken/", width = 15, height= 7)
```

# Grafiken für den Anhang 

## Vergleich der Gewinne/Verluste an Prozentpunkten der Erststimmen von SPD und Union (bzgl. der Bundestagswahl 2017)

```{r}
data.frame(list(union_diff= union_erst$DiffProzentPkt,
                spd_diff= spd_erst$DiffProzentPkt,
                Wahlkreis.Nr= union_erst$Wahlkreis.Nr)) %>% 
  ggplot(aes(x= union_diff, y= spd_diff))+
  geom_point(alpha= 0.7)+
  scale_x_continuous(limits = c(-25, 10))+
  geom_hline(yintercept = 0, linetype= "dashed", colour= "black")+
  geom_vline(xintercept = 0, linetype= "dashed", colour= "black")+
  ggtitle("Vergleich der Gewinne/Verluste an Prozentpunkten der Erststimmen\n von SPD und UNION (bzgl. der Bundestagswahl 2017")+
  xlab("UNION Differenz der Prozenpunkte (Erststimmen)")+
  ylab("SPD Differenz der Prozentpunkte (Erststimmen)")

ggsave("Erst_Union_SPD_Diff_Scatter.png", path="Grafiken/", width = 7, height= 7)
```

## In welchen Wahlkreisen gab es die größte Veränderung zur Briefwahl?
- Alle Wahlkreise deutliches Plus bei Urnenwahl im Vergleich zu 2017
```{r}

btw_brief_urne_all %>% 
  mutate(Urnenwaehler_21= B_21 - B1Briefwähler_21,
         Urnenwaehler_17= B_17 - B1Briefwähler_17) %>% 
  mutate(BriefDiff= B1Briefwähler_21/B_21- B1Briefwähler_17/B_17,
         UrneDiff= Urnenwaehler_21/B_21 - Urnenwaehler_17/B_17) %>% 
  arrange(BriefDiff) %>% 
  left_join(y= wk_shp, by= c("schluessel"="WKR_NR")) %>% 
  ggplot() +
  geom_sf(aes(geometry= geometry, fill= BriefDiff))+
  scale_fill_continuous_diverging(name="Differenz der Prozentpunkte (Briefwahl 2021/2017)", palette= "Blue-Yellow 2", limit= c(-0.1,0.3))+
  theme_map()

```
### Ausgabe der Prozentualen Anteile nach Art pro Jahr
```{r}
total_brief_urne_21_17_df %>% 
  mutate(Perc= Anzahl/Gesamt.Anzahl) %>% 
  select(Jahr, Art, Perc) %>% 
  arrange(Art)
```

# FW Korrelationsmatrix
```{r}
cor_matrix_FW_melted %>% 
  filter(Var1 %in% c("FW.Erst.End.Perc", "FW.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y=reorder(Var2,-value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller("Korrelation (Pearson)",palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(colour = "white"))+
  xlab("Anteil an Zweitstimmen für die freien Wähler")
```

```{r}
btw_trimmed_geo_data <-  btw_trimmed_geo_data %>% 
  mutate(CSU.Zweit.End.Perc_nafree =replace_na(CSU.Zweit.End.Perc,0)) %>%
  mutate(CDU.Zweit.End.Perc_nafree =replace_na(CDU.Zweit.End.Perc,0)) %>%
  mutate(Union.Zweit.End.Perc= CSU.Zweit.End.Perc_nafree + CDU.Zweit.End.Perc_nafree)
```

# Anteil an Zweitstimmen (Maps) für jede Partei
```{r}
btw_trimmed_geo_data %>% 
  mutate(CSU.Zweit.End.Perc_nafree =replace_na(CSU.Zweit.End.Perc,0)) %>%
  mutate(CDU.Zweit.End.Perc_nafree =replace_na(CDU.Zweit.End.Perc,0)) %>%
  mutate(Union.Zweit.End.Perc= CSU.Zweit.End.Perc_nafree + CDU.Zweit.End.Perc_nafree) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= Union.Zweit.End.Perc))+
  scale_fill_continuous_sequential(name= "Zweitstimmenanteil der Union in Prozent", palette = "Grays",
                                   breaks= seq(from=0,0.5, 0.05))+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der Union (CDU/CSU)")

```
## Union
```{r}
btw_trimmed_geo_data %>% 
  mutate(CSU.Zweit.End.Perc_nafree =replace_na(CSU.Zweit.End.Perc,0)) %>%
  mutate(CDU.Zweit.End.Perc_nafree =replace_na(CDU.Zweit.End.Perc,0)) %>%
  mutate(Union.Zweit.End.Perc= CSU.Zweit.End.Perc_nafree + CDU.Zweit.End.Perc_nafree) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= Union.Zweit.End.Perc))+
  scale_fill_continuous_sequential(name= "Zweitstimmenanteil der Union in Prozent", palette = "Grays",
                                   breaks= seq(from=0,0.5, 0.05))+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der Union (CDU/CSU)")

ggsave("Union_Zweit_Map.png", path = "Grafiken/", width= 9, height= 9)
```
## SPD
```{r}
btw_trimmed_geo_data %>%
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= SPD.Zweit.End.Perc))+
  scale_fill_continuous_sequential(name= "Zweitstimmenanteil der SPD in Prozent", palette = "Reds3",
                                   breaks= seq(from=0,0.5, 0.05))+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der SPD")
ggsave("SPD_Zweit_Map.png", path = "Grafiken/", width= 9, height= 9)
```
## AFD
```{r}
btw_trimmed_geo_data %>%
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= AFD.Zweit.End.Perc))+
  scale_fill_continuous_sequential(name= "Zweitstimmenanteil der AFD in Prozent", palette = "Blues3",
                                   breaks= seq(from=0,0.5, 0.05))+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der AFD")
ggsave("AFD_Zweit_Map.png", path = "Grafiken/", width= 9, height= 9)
```
## FDP
```{r}
btw_trimmed_geo_data %>%
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= FDP.Zweit.End.Perc))+
  scale_fill_continuous("Zweitstimmenanteil der FDP in Prozent", low= "#ffffff", high="#fff44f")+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der FDP")
ggsave("FDP_Zweit_Map.png", path = "Grafiken/", width= 9, height= 9)
```
## Grüne
```{r}
btw_trimmed_geo_data %>%
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= GRÜNE.Zweit.End.Perc))+
  scale_fill_continuous_sequential(name= "Zweitstimmenanteil der AFD in Prozent", palette = "Greens",
                                   breaks= seq(from=0,0.5, 0.05))+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der Grünen")
ggsave("Gruene_Zweit_Map.png", path = "Grafiken/", width= 9, height= 9)
```

## Die Linke
```{r}
btw_trimmed_geo_data %>%
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= LINKE.Zweit.End.Perc))+
  scale_fill_continuous_sequential(name= "Zweitstimmenanteil der Linken in Prozent", palette = "Reds2",
                                   breaks= seq(from=0,0.2, 0.05))+
  theme_map()+
  ggtitle("Zweitstimmenanteil in Prozent der Linken")
ggsave("Linke_Zweit_Map.png", path = "Grafiken/", width= 9, height= 9)
```


## Hang zu extremen Randparteien (LINKE und AFD) speziell im Osten?
```{r}
btw_trimmed_geo_data %>% 
  mutate(Rand.Zweit.End.Perc= LINKE.Zweit.End.Perc + AFD.Zweit.End.Perc) %>% 
  ggplot()+
  geom_sf(aes(geometry= geometry, fill= Rand.Zweit.End.Perc),
          color= "darkgrey")+
  geom_sf(data = länder, color = "black", fill = NA)+
  scale_fill_viridis(option= "magma", trans= "reverse")+
  ggtitle("Stimmanteile an Zweitstimmen der Randparteien (AFD und Die Linke)")+
  labs(fill= "Stimmanteile der Randparteien (Zweitstimmen)")+
  theme_map()

ggsave("Randparteien_Bund_Map.png", path = "Grafiken/", width= 9, height= 9)
```



# Korrelationenen Struktur in den neuen Bundesländern AFD

```{r}
AFD_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,AFD.Erst.End.Perc,AFD.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) %>%
  filter(Bundesland.Nr %in% 11:16)

cor_matrix_AFD <- cor(AFD_struktur) 
cor_matrix_AFD_melted <- melt(cor_matrix_AFD) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_AFD_melted %>% 
  filter(Var1 %in% c("AFD.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller("Korrelation (Pearson)",palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(color="white"))+
  xlab("Anteil der AFD Zweitstimmen in Prozent")+
  ylab("Strukturvariablen")
```

# Korrelationenen Struktur in den neuen Bundesländern LINKE

```{r}
LINKE_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,LINKE.Erst.End.Perc, LINKE.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) %>%
  filter(Bundesland.Nr %in% 11:16)

cor_matrix_LINKE <- cor(LINKE_struktur) 
cor_matrix_LINKE_melted <- melt(cor_matrix_LINKE) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_LINKE_melted %>% 
  filter(Var1 %in% c("LINKE.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller("Korrelation (Pearson)",palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(color="white"))+
  xlab("Anteil der AFD Zweitstimmen in Prozent")+
  ylab("Strukturvariablen")
```

## Ü60 AFD Scatterplot (WEST/OST)
```{r}

btw_trimmed_data %>%
  mutate(is.Osten= Bundesland.Nr %in% c(11:16)) %>%
  mutate(is.Osten_fct= as.factor(is.Osten)) %>% 
  mutate(f60tInf.Perctange= f60t74.Perctange+f75tInf.Perctange) %>% 
ggplot(aes(y= AFD.Zweit.End.Perc, x= f60tInf.Perctange))+
  facet_wrap(~is.Osten_fct, labeller = labeller(is.Osten_fct= c("FALSE"= "Alte Bundesländer", 
                                                                "TRUE"= "Neue Bundesländer")))+
  geom_point(alpha= 0.5)+
  ggtitle("Anteil der über 60-jährigen und Anteil der AFD Zweitstimmen in Ost und West")+
  xlab("Anteil der über 60-jährigen in Prozent")+
  ylab("Anteil an Zweitstimmen für die AFD")
  
ggsave("AFD_ue60_O-W_Sctter.png", path = "Grafiken/", width= 9, height= 9)
```

## Ü60 Randparteien Scatterplot OST/WEST
```{r}
btw_trimmed_data %>%
  mutate(is.Osten= as.factor(Bundesland.Nr %in% c(11:16))) %>%
  mutate(is.Berlin= Bundesland.Nr%in% c(11)) %>% 
  mutate(Rand.Zweit.End.Perc= LINKE.Zweit.End.Perc + AFD.Zweit.End.Perc) %>% 
  mutate(f60tInf.Perctange= f60t74.Perctange+f75tInf.Perctange) %>% 
ggplot(aes(y= Rand.Zweit.End.Perc, x= f60tInf.Perctange))+
  facet_wrap(~is.Osten, labeller = labeller(is.Osten= c("FALSE"= "Alte Bundesländer", "TRUE"= "Neue Bundesländer")))+
  geom_point()+
  ggtitle("Anteil der über 60-jährigen und Anteil an Zweitstimmen für AFD und Linke")+
  xlab("Anteil der über 60-jährigen in Prozent")+
  ylab("Anteil an Zweitstimmen für Randparteien (AFD u. Linke")

ggsave("Rand_ue60_O-W_Sctter.png", path = "Grafiken/", width= 9, height= 9)
```

## Heatmap Korrelationsmatrix Strukturvariablen 

```{r}
struktur_only <- btw_trimmed_data %>% 
  select(76:ncol(btw_trimmed_data))

cor_matrix <- cor(struktur_only, use= "pairwise.complete.obs")

cor_matrix_melted <- melt(cor_matrix)

# dev.off()
limit <- max(abs(cor_matrix_melted$value)) * c(-1, 1)


ggplot(data = cor_matrix_melted, aes(x=Var1, y=Var2, fill=value)) + 
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
theme(axis.text.x=element_text(angle=90,hjust=1))+
  ggtitle("Korrelationsmatrix der Strukturvariablen")

ggsave("Korr_Matrix_Strukturvariablen.png", path = "Grafiken/", width = 7, height= 7)
```

## Kormatrix SPD
```{r}
SPD_struktur <- btw_trimmed_geo_data %>% 
  select(Bundesland.Nr ,SPD.Erst.End.Perc,SPD.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) 

cor_matrix_SPD <- cor(SPD_struktur, use= "pairwise") 
cor_matrix_SPD_melted <- melt(cor_matrix_SPD) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_SPD_melted %>% 
  filter(Var1 %in% c("SPD.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller("Korrelation (Pearson)",palette= "RdBu", type = "div", limit= c(-1,1))+
  theme(axis.text.x=element_text(color="white"))+
  xlab("Anteil der SPD Zweitstimmen in Prozent")+
  ylab("Strukturvariablen")
  

ggsave("Kor_Matrix_SPD_Struktur.png", path = "Grafiken/", width = 7, height= 7)
```

## Kormatrix Union
```{r}
UNION_struktur <- btw_trimmed_geo_data %>% 
  replace(is.na(.), 0) %>% 
  mutate(UNION.Erst.End.Perc= CDU.Erst.End.Perc + CSU.Erst.End.Perc, 
         UNION.Zweit.End.Perc= CDU.Zweit.End.Perc + CSU.Zweit.End.Perc) %>% 
  select(Bundesland.Nr ,UNION.Erst.End.Perc,UNION.Zweit.End.Perc, 76:ncol(btw_trimmed_geo_data), -geometry) 
  
cor_matrix_UNION <- cor(UNION_struktur, use= "complete") 
cor_matrix_UNION_melted <- melt(cor_matrix_UNION) %>% 
  arrange(desc(value))

# dev.off()
cor_matrix_UNION_melted %>% 
  filter(Var1 %in% c("UNION.Zweit.End.Perc")) %>% 
ggplot(aes(x=Var1, y= reorder(Var2, -value), fill=value)) +  
  geom_raster()+
  scale_fill_distiller(palette= "RdBu", type = "div", limit= c(-1,1))+
  theme(axis.text.x=element_text(color="white"))+
  xlab("Anteil der Unions Zweitstimmen in Prozent")+
  ylab("Strukturvariablen")

ggsave("Kor_Matrix_UNION_Struktur.png", path = "Grafiken/", width = 7, height= 7)
```

#### Andere Plots bzgl. Gewinn/Verluste (nicht in Anhang)
```{r}
SPD_CDU_CSU_Diff%>% 
  ggplot(aes(x= Gruppenname, y= DiffProzentPkt))+
  geom_boxplot()

SPD_CDU_CSU_Diff %>% 
  ggplot(aes(x= Gruppenname, y= DiffProzentPkt))+
  geom_boxplot()+
  geom_hline(yintercept = 0, linetype= "dashed", colour= "black")+
  ggtitle("Vergleich der Gewinne/Verluste an Prozentpunkten der Zweitstimmen von SPD und Union (bzgl. der Bundestagswahl 2017")+
  xlab("Partei")+
  ylab("Differenz Prozentpunkte (Zweitstimmen)")
```
